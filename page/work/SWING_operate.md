# SWING 운영 개선

Time: 2022-11-14 <br>
Tags: Android, CameraX, Jetpack, Kotlin, ML kit, WorkManager <br>
URL: https://play.google.com/store/apps/details?id=com.co.swing&hl=ko

<aside>
💡 본 프로젝트에서는 SWING Android App을 운영 개선하며 UX에 대해 고민하고, 성능 개선, 다른 팀이 사용할때 어떤 것이 더 편리할 것인가에 대한 고민을 많이 해볼 수 있었습니다.

</aside>

### 프로젝트 설명

- SWING 앱 운영
- SWING 앱 UX 개선
- SWING 앱 성능 개선

### 사용기술

- Language: Kotlin
- OS: Android
- Library: Jetpack,

---

### 주요업무

- QR 인식 성능 개선
- 반납사진 광각 촬영 기능
- 라이드 중 길찾기 기능 추가

---

### 기존 프로젝트 문제점 분석 및 개선

1. QR 인식 성능 개선
    
    기존 프로젝트에는 이러한 문제점이 존재하였습니다
    
    - 초점이 바로 잡히지 않아서 QR을 인식하기까지 시간이 1초 이상 소비되는 경우가 많음
    - Bitmap을 직접 분석하는에서 QR을 디코드하는 시간도 추가됨
    
    이 문제를 이렇게 해결하였습니다
    
    - google에서 직접 지원하는 `CameraX`와 `ML kit`을 사용해서 해결
    - `CameraX`에서 지원하는 `ImageAnalysis` 와 `ML kit`을 함께 이용하여 `ImageProxy` 객체를 실시간으로 받아와서 `ML kit`으로 빠르게 QR이 분석가능해짐
        - 1초 이상에서 0.5초 아래로 성능 개선
    
2. 반납 사진 촬영 기능 광각 카메라 지원
    
    기존 프로젝트에서는 반납 사진 촬영에 관련해서 하기와 같은 문제점이 있었습니다.
    
    - `3 party library`를 사용하여 광각 카메라를 사용하도록 커스텀이 불가능
    - 일반 카메라로만 촬영된 반납 사진으로는 유저도 반납 위치를 찾기 힘들고, 운영팀도 수거배치에 어려움을 겪음
    
    이를 해결하기 위해, 다음과 같이 사진 촬영 기능을 설계했습니다.
    
    - `CameraX`, `Camera2`라이브러리 적용
    - `Camera2CameraInfo` 를 사용하여 전체 카메라 중 후면이고 포커스의 거리가 2.5f 아래인 카메라를 찾아서 사용
        - 여러 기기로 테스트해본 결과 제조사마다 광각 카메라의 index가 다른 것을 발견
        - 광각 카메라의 경우 포커스 거리가 보통 2.5f 미만인 것을 확인하고 2.5f 아래의 카메라를 선택하도록 구현
    - `ImageCapture.OnImageSavedCallback` 를 사용하여 사진이 저장되면 Bitmap을 압축하여 `workManager`로 백그라운드에서 사진을 저장하고 서버로 전송
        - 사진이 뒤집어 져서 촬영되는 현상이 있어서 추후 메타데이터(`Exif`)를 이용해서 사진을 돌인 후 서버에 전송하도록 수정
    
3. 최근 검색 기록 개선
    
    기존 프로젝트에서는 최근 검색 기록 기능에 관련해서 하기와 같은 문제점이 있었습니다.
    
    - `Room`과 `StateFlow`를 이용해서 처음에 데이터를 로드하는 속도가 느림
    - 최대 10개의 데이터를 내부 저장소에서 불러오는데 비용이 너무 큼
    - 데이터를 로드하기 전까지 로딩 화면이 노출되게 됨
    
    이를 해결하기 위해, 다음과 같이 최근 검색 기록 기능을 개선했습니다.
    
    - gson을 통해 객체를 직렬화하여 문자열로 변경
    - `sharedpreferences`에 저장하도록 변경
    - DB를 열어 데이터를 로드하는게 아니라 문자열을 불러오는 로직이 되어 속도 개선
        - 0.5초 근처에서 0.1초로 성능 개선
    
4. 라이드 중 길찾기 추가
    
    기존 프로젝트에서는 길찾기 기능에 관련해서 하기와 같은 문제점이 있었습니다.
    
    - 기기 탑승 전에 경로를 보고 기기를 탑승하는 시나리오로 구현
    - 기기를 탑승 중일때는 길찾기가 불가능
    
    이를 해결하기 위해, 다음과 같이 최근 검색 기록 기능을 개선했습니다.
    
    - 탑승중일때 상단에 검색 버튼을 구현
    - 검색 버튼을 누르면 검색 → 목적지 선택 → 경로 표시 시나리오를 연결
    - 경로 표시 화면 하단에 탑승중에 보이는 `BottomSheet`을 추가하여 탑승중임을 표시